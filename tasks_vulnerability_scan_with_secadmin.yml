---
- name: Créer un dossier pour les fichiers OVAL et le rapport
  file:
    path: /home/secadmin/oval_scan
    state: directory
    owner: secadmin
    group: secadmin
    mode: '0755'

- name: Définir la date du jour pour nommer les fichiers
  set_fact:
    today_date: "{{ ansible_date_time.date }}"
    oval_bz2_file: "oci.com.ubuntu.focal.usn.oval.xml.bz2"
    oval_xml_file: "oci.com.ubuntu.focal.usn.oval.xml"
    report_file: "report_{{ ansible_date_time.date }}.html"

- name: Télécharger le fichier OVAL compressé pour Ubuntu 20.04 (focal)
  get_url:
    url: https://security-metadata.canonical.com/oval/oci.com.ubuntu.focal.usn.oval.xml.bz2
    dest: "/home/secadmin/oval_scan/{{ oval_bz2_file }}"
    mode: '0644'

- name: Décompresser le fichier OVAL
  unarchive:
    src: "/home/secadmin/oval_scan/{{ oval_bz2_file }}"
    dest: "/home/secadmin/oval_scan/"
    remote_src: yes
    creates: "/home/secadmin/oval_scan/{{ oval_xml_file }}"

- name: Télécharger le fichier manifest
  get_url:
    url: https://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64-root.manifest
    dest: /home/secadmin/oval_scan/manifest
    mode: '0644'

- name: Exécuter l'analyse avec OpenSCAP
  command: >
    oscap oval eval --report {{ report_file }} {{ oval_xml_file }}
  args:
    chdir: /home/secadmin/oval_scan

- name: Afficher l'emplacement du rapport généré
  debug:
    msg: "Analyse terminée. Rapport généré dans /home/secadmin/oval_scan/{{ report_file }}"